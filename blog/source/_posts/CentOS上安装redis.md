---
title: CentOSä¸Šå®‰è£…redis
date: 2018-07-13 15:04:21
tags: Redis
categories: æ•°æ®åº“
---

### ç›®çš„
ä¸ºäº†ç»ƒä¹ åœ¨springbootä¸­ä½¿ç”¨redisæ•°æ®åº“ï¼Œæœ¬äººæ¯”è¾ƒæ‡’ ä¸æƒ³æŠŠredisæ•°æ®åº“è£…åœ¨æœ¬åœ°ï¼Œæ­£å¥½æœ‰ä¸€ä¸ªå…è´¹çš„æœåŠ¡å™¨å¯ä»¥çŽ© ã€‚ äºŽæ˜¯åœ¨linuxä¸Šå®‰è£…redisï¼Œä¸‹é¢æ˜¯å®‰è£…redisé‡åˆ°çš„å‘ã€‚
### å¼€å§‹
> ç³»ç»Ÿ: CentOS Linux release 7.4.1708 (Core) </br>
> redisç‰ˆæœ¬: redis-4.0.10 </br>
> rediså®˜ç½‘: http://www.redis.cn/download.html

ç¬¬ä¸€æ­¥å½“ç„¶æ˜¯æŒ‰ç…§å®˜æ–¹çš„æ­¥éª¤ä¸€æ­¥ä¸€æ­¥æ¥ç€ã€‚
>$ wget http://download.redis.io/releases/redis-4.0.10.tar.gz </br>
>$ tar xzf redis-4.0.10.tar.gz <br>
>$ cd redis-4.0.10 <br>
>$ make


å—¯å—¯ ä¸€æ°”å‘µæˆã€‚æ²¡å•¥å‘å˜› å“ˆå“ˆ æƒ³å¤šäº†
> make[3]: gccï¼šå‘½ä»¤æœªæ‰¾åˆ°

æ©æ©é¢ å¥½å§ å®‰è£…gcc
> yum -y install gcc automake autoconf libtool make

.......................<br>
è¿›è¿‡ä¸€æ®µæ—¶é—´çš„ç­‰å¾… ç»ˆäºŽæžå®šgccäº†ï¼ ç»§ç»­make
> zmalloc.h:50:31: è‡´å‘½é”™è¯¯ï¼šjemalloc/jemalloc.hï¼šæ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•
 #include <jemalloc/jemalloc.h>

 WTFï¼Ÿï¼Ÿ
 é©¬ä¸¹ è¿™æ˜¯ä»€ä¹ˆðŸ‘» äºŒè¯ä¸è¯´ï¼Œç™¾åº¦
 è§£å†³æ–¹æ³•ï¼š
 > make MALLOC=libc

 è¿™æ˜¯å•¥ï¼Ÿä¸ºå•¥è¦è¿™ä¹ˆåšï¼Ÿç½‘ä¸Šæ²¡æ‰¾åˆ°ç­”æ¡ˆ é—®äº†å¤§ä½¬æ‰çŸ¥é“MALLOC=libcæ˜¯ 
 * ç¼–è¯‘å¹¶æŒ‡å®šåŠ¨æ€å†…å­˜åˆ†é…åŠŸèƒ½ä½¿ç”¨libcæä¾›çš„
 


 åŽŸæ¥æ˜¯å†…å­˜åˆ†é…çš„å•Š ä¸ºå•¥redisè¦ç”¨è¿™ä¸ªåŠŸèƒ½å‘¢ æ¥çœ‹çœ‹redisçš„åŽŸç†ï¼š
 > Redisæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªKey-Valueç±»åž‹çš„å†…å­˜æ•°æ®åº“ï¼Œå¾ˆåƒmemcachedï¼Œæ•´ä¸ªæ•°æ®åº“ç»Ÿç»ŸåŠ è½½åœ¨å†…å­˜å½“ä¸­è¿›è¡Œæ“ä½œï¼Œå®šæœŸé€šè¿‡å¼‚æ­¥æ“ä½œæŠŠæ•°æ®åº“æ•°æ®flushåˆ°ç¡¬ç›˜ä¸Šè¿›è¡Œä¿å­˜ã€‚å› ä¸ºæ˜¯çº¯å†…å­˜æ“ä½œï¼ŒRedisçš„æ€§èƒ½éžå¸¸å‡ºè‰²ï¼Œæ¯ç§’å¯ä»¥å¤„ç†è¶…è¿‡ 10ä¸‡æ¬¡è¯»å†™æ“ä½œï¼Œæ˜¯å·²çŸ¥æ€§èƒ½æœ€å¿«çš„Key-Value DBã€‚
Redisçš„å‡ºè‰²ä¹‹å¤„ä¸ä»…ä»…æ˜¯æ€§èƒ½ï¼ŒRedisæœ€å¤§çš„é­…åŠ›æ˜¯æ”¯æŒä¿å­˜å¤šç§æ•°æ®ç»“æž„ï¼Œæ­¤å¤–å•ä¸ªvalueçš„æœ€å¤§é™åˆ¶æ˜¯1GBï¼Œä¸åƒ memcachedåªèƒ½ä¿å­˜1MBçš„æ•°æ®ï¼Œå› æ­¤Rediså¯ä»¥ç”¨æ¥å®žçŽ°å¾ˆå¤šæœ‰ç”¨çš„åŠŸèƒ½ï¼Œæ¯”æ–¹è¯´ç”¨ä»–çš„Listæ¥åšFIFOåŒå‘é“¾è¡¨ï¼Œå®žçŽ°ä¸€ä¸ªè½»é‡çº§çš„é«˜æ€§ èƒ½æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œç”¨ä»–çš„Setå¯ä»¥åšé«˜æ€§èƒ½çš„tagç³»ç»Ÿç­‰ç­‰ã€‚å¦å¤–Redisä¹Ÿå¯ä»¥å¯¹å­˜å…¥çš„Key-Valueè®¾ç½®expireæ—¶é—´ï¼Œå› æ­¤ä¹Ÿå¯ä»¥è¢«å½“ä½œä¸€ ä¸ªåŠŸèƒ½åŠ å¼ºç‰ˆçš„memcachedæ¥ç”¨ã€‚
Redisçš„ä¸»è¦ç¼ºç‚¹æ˜¯æ•°æ®åº“å®¹é‡å—åˆ°ç‰©ç†å†…å­˜çš„é™åˆ¶ï¼Œä¸èƒ½ç”¨ä½œæµ·é‡æ•°æ®çš„é«˜æ€§èƒ½è¯»å†™ï¼Œå› æ­¤Redisé€‚åˆçš„åœºæ™¯ä¸»è¦å±€é™åœ¨è¾ƒå°æ•°æ®é‡çš„é«˜æ€§èƒ½æ“ä½œå’Œè¿ç®—ä¸Š


æ©æ©é¢ åŽŸæ¥redisç»å¸¸å’Œå†…å­˜æ‰“äº¤é“å•Š å†æ¥çœ‹çœ‹jemallocå¹²å˜›ç”¨çš„ï¼š
> jemallocæ˜¯ä¸€ä¸ªé€šç”¨çš„mallocï¼ˆ3ï¼‰å®žçŽ°ï¼Œå®ƒå¼ºè°ƒäº†
ç¢Žç‰‡é¿å…å’Œå¯æ‰©å±•çš„å¹¶å‘æ”¯æŒã€‚jemalloc 
äºŽ2005å¹´é¦–æ¬¡ä½œä¸ºFreeBSD libcåˆ†é…å™¨ä½¿ç”¨ï¼Œä»Žé‚£ä»¥åŽå®ƒå·²ç»
è¿›å…¥è®¸å¤šä¾èµ–äºŽå…¶å¯é¢„æµ‹è¡Œä¸ºçš„åº”ç”¨ç¨‹åºã€‚2010å¹´ï¼Œ
jemallocå¼€å‘å·¥ä½œèŒƒå›´æ‰©å¤§åˆ°åŒ…æ‹¬å¼€å‘äººå‘˜æ”¯æŒåŠŸèƒ½
ï¼Œå¦‚å †åˆ†æžå’Œå¹¿æ³›çš„ç›‘æŽ§/è°ƒä¼˜é’©å­ã€‚çŽ°ä»£jemalloc 
ç‰ˆæœ¬ç»§ç»­è¢«é›†æˆåˆ°FreeBSDä¸­ï¼Œå› æ­¤å¤šåŠŸèƒ½æ€§
ä»ç„¶è‡³å…³é‡è¦ã€‚æ­£åœ¨è¿›è¡Œçš„å¼€å‘å·¥ä½œè¶‹åŠ¿æ˜¯å°†jemalloc 
ä½œä¸ºå¹¿æ³›çš„è‹›åˆ»åº”ç”¨çš„æœ€ä½³åˆ†é…å™¨ä¹‹ä¸€ï¼Œå¹¶ä¸”
æ¶ˆé™¤/å‡è½»å¯¹çŽ°å®ž
ä¸–ç•Œåº”ç”¨äº§ç”Ÿå®žé™…å½±å“çš„å¼±ç‚¹ã€‚

ä¸ªäººç†è§£çš„æ˜¯
> redisä¸»è¦æ˜¯åœ¨å†…å­˜ä¸Šæ“ä½œ è€Œåœ¨å†…å­˜ä¸Šæ“ä½œå°±ä¸å¯é¿å…çš„ä¼šäº§ç”Ÿå†…å­˜ç¢Žç‰‡  ä¸ºäº†ä¼˜åŒ–å†…å­˜ç¢Žç‰‡æ‰é€‰æ‹©çš„æ˜¯jemalloc

å¥½ å®‰è£…jemalloc

#### å®‰è£…jemalloc

>#ä¸‹è½½ <br>
 wget https://github.com/jemalloc/jemalloc/releases/download/4.2.1/jemalloc-4.2.1.tar.bz2  <br>
> #è§£åŽ‹ <br>
>tar -xjvf jemalloc-4.2.1.tar.bz2 <br>
>#åœ¨jemalloc-4.2.1ç›®å½•ä¸‹é¢„ç¼–è¯‘<br>
>./configure â€“prefix=/usr/local/jemalloc<br>
>#ç¼–è¯‘<br>
>make -j8 && make install

å®Œæˆ ä½†æ˜¯ä¸æ™“å¾—ä¸ºå•¥è¿è¡Œè¿˜æ˜¯æœ‰é‚£ä¸ªé”™è¯¯ æˆ‘æ˜¯linuxå°ç™½ã€‚ã€‚ã€‚
**********
#### ç›´æŽ¥å®‰è£…jemallocä¾èµ–

githubä¸Šçš„issuesæ—©å°±å‘Šè¯‰äº†æˆ‘ä»¬ç­”æ¡ˆ
* https://github.com/antirez/redis/issues/722

åœ¨redisç›®å½•ä¸‹è¿›å…¥ 
> cd deps

å®‰è£…jemallocä¾èµ–
> make hiredis lua jemalloc linenoise

> cd ../

é‡æ–°ç¼–è¯‘
> make

æˆåŠŸ

### å¯åŠ¨redis

> src/redis-server