<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="iOS PDF添加水印"><meta name="keywords" content="学习"><meta name="author" content="roMummy"><meta name="copyright" content="roMummy"><title>iOS PDF添加水印 | roMummy</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.2'
} </script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="roMummy" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#iOS-PDF%E6%B7%BB%E5%8A%A0%E6%B0%B4%E5%8D%B0"><span class="toc-number">1.</span> <span class="toc-text">iOS PDF添加水印</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.</span> <span class="toc-text">实现功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E5%B1%95%E7%A4%BA"><span class="toc-number">1.3.</span> <span class="toc-text">页面展示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%96%99"><span class="toc-number">1.4.</span> <span class="toc-text">资料</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://ss0.bdstatic.com/94oJfD_bAAcT8t7mm9GUKT-xh_/timg?image&amp;quality=100&amp;size=b4000_4000&amp;sec=1530072864&amp;di=b83735a6b8cfd2147078a2bbf06d7570&amp;src=http://ww2.sinaimg.cn/wap720/63a4b031jw1f4lxxamw0jj218g0qodib.jpg"></div><div class="author-info__name text-center">roMummy</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/roMummy">github</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">5</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">3</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://github.com/roMummy">me</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/top.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">roMummy</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">档案</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">类别</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">iOS PDF添加水印</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-07-20</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/iOS/">iOS</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">1.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 6 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="iOS-PDF添加水印"><a href="#iOS-PDF添加水印" class="headerlink" title="iOS PDF添加水印"></a>iOS PDF添加水印</h2><p>最近在做PDF相关的项目，记录一下</p>
<h3 id="实现功能"><a href="#实现功能" class="headerlink" title="实现功能"></a>实现功能</h3><ul>
<li>支持添加文字水印</li>
<li>支持旋转</li>
<li>支持导出</li>
<li>支持透明度</li>
<li>支持图层</li>
<li>支持平铺</li>
<li>支持添加页面范围</li>
<li>支持字体样式设置</li>
<li>支持实时变更</li>
</ul>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><ul>
<li><p>通过使用苹果自带的PDFKit来实现。</p>
<p>PDFDocument有一个delegate，其中有一个代理方法<code>func classForPage() -&gt; AnyClass</code>，这个方法可以让我们自己绘制PDFPage。绘制好PDF之后就可以使用PDFDocument提供的<code>write(toFile path: String) -&gt; Bool</code>来导出。</p>
</li>
</ul>
<p>###具体实现</p>
<ul>
<li><p>绘制水印</p>
<p>创建一个全新的PDFPage</p>
<p>然后重写<code>func draw(with box: PDFDisplayBox, to context: CGContext)</code>方法</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PDFWatermarkPage</span>: <span class="title class_">PDFPage</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> pageIndex: <span class="type">Int</span>? &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> label <span class="operator">=</span> label &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="type">Int</span>(label)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">draw</span>(<span class="params">with</span> <span class="params">box</span>: <span class="type">PDFDisplayBox</span>, <span class="params">to</span> <span class="params">context</span>: <span class="type">CGContext</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>.draw(with: box, to: context)</span><br><span class="line">        <span class="keyword">let</span> config <span class="operator">=</span> <span class="type">PDFWatermarkTool</span>.<span class="type">PageConfiguration</span>.shared.configuration</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> pageIndex <span class="operator">=</span> pageIndex <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> pageIndex <span class="operator">&lt;</span> config.startPageIndex &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> pageIndex <span class="operator">&gt;</span> config.endPageIndex &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">UIGraphicsPushContext</span>(context)</span><br><span class="line">        context.saveGState()</span><br><span class="line">        <span class="keyword">let</span> pageBounds <span class="operator">=</span> bounds(for: box)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;page - <span class="subst">\(label)</span>&quot;</span>)</span><br><span class="line">        <span class="comment">// 渲染文字</span></span><br><span class="line">        drawWatermark(config: config, contextWidth: pageBounds.width, contextHeight: pageBounds.height)</span><br><span class="line">        </span><br><span class="line">        context.restoreGState()</span><br><span class="line">        <span class="type">UIGraphicsPopContext</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// 计算整个页面可以绘制多少个文本 然后循环绘制文本</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">drawWatermark</span>(<span class="params">config</span>: <span class="type">PDFWatermarkTool</span>.<span class="type">Configuration</span>,</span><br><span class="line">                       <span class="params">contextWidth</span>: <span class="type">CGFloat</span>,</span><br><span class="line">                       <span class="params">contextHeight</span>: <span class="type">CGFloat</span>) &#123;</span><br><span class="line">        <span class="keyword">guard</span> config.text.count <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 斜线长</span></span><br><span class="line">        <span class="keyword">let</span> sqrtLength <span class="operator">=</span> sqrt(contextWidth <span class="operator">*</span> contextWidth <span class="operator">+</span> contextHeight <span class="operator">*</span> contextHeight)</span><br><span class="line">        <span class="comment">// 绘制文字的属性</span></span><br><span class="line">        <span class="keyword">let</span> attributes <span class="operator">=</span> [</span><br><span class="line">            <span class="type">NSAttributedString</span>.<span class="type">Key</span>.foregroundColor: config.textColor.withAlphaComponent(config.textAlpha),</span><br><span class="line">            <span class="type">NSAttributedString</span>.<span class="type">Key</span>.font: config.textFont,</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">let</span> mAttributesStr <span class="operator">=</span> <span class="type">NSMutableAttributedString</span>(string: config.text, attributes: attributes)</span><br><span class="line">        <span class="comment">// 绘制文字的宽高</span></span><br><span class="line">        <span class="keyword">let</span> mStrW <span class="operator">=</span> mAttributesStr.size().width</span><br><span class="line">        <span class="keyword">let</span> mStrH <span class="operator">=</span> mAttributesStr.size().height</span><br><span class="line">        <span class="comment">// 文字间距</span></span><br><span class="line">        <span class="keyword">let</span> verticalSpace: <span class="type">CGFloat</span> <span class="operator">=</span> config.textVerticalSpace</span><br><span class="line">        <span class="keyword">let</span> horizontalSpace: <span class="type">CGFloat</span> <span class="operator">=</span> config.textHorizontalSpace</span><br><span class="line">                </span><br><span class="line">        <span class="comment">// 获取上下文</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> context <span class="operator">=</span> <span class="type">UIGraphicsGetCurrentContext</span>() <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 保存上下文，压栈</span></span><br><span class="line">        context.saveGState()</span><br><span class="line">        <span class="comment">// 翻转坐标系，圆点从左下角变化到左上角</span></span><br><span class="line">        context.translateBy(x: <span class="number">0</span>, y: contextHeight)</span><br><span class="line">        context.scaleBy(x: <span class="number">1.0</span>, y: <span class="operator">-</span><span class="number">1.0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 移动绘制圆点到画布中心</span></span><br><span class="line">        context.translateBy(x: contextWidth<span class="operator">/</span><span class="number">2.0</span>, y: contextHeight<span class="operator">/</span><span class="number">2.0</span>)</span><br><span class="line">        <span class="comment">// 旋转</span></span><br><span class="line">        <span class="comment">// 导出的时候需要特殊处理旋转角度</span></span><br><span class="line">        <span class="keyword">let</span> angle <span class="operator">=</span> config.isExport <span class="operator">?</span> (config.textAngle <span class="operator">-</span> rotation): config.textAngle</span><br><span class="line">        context.rotate(by: <span class="type">CGFloat</span>(angle)<span class="operator">*</span>(<span class="type">CGFloat</span>.pi<span class="operator">/</span><span class="number">180.0</span>))</span><br><span class="line">        <span class="comment">// 将绘制原点恢复初始值，保证当前context中心和源image的中心处在一个点(当前context已经旋转，所以绘制出的任何layer都是倾斜的)</span></span><br><span class="line">        context.translateBy(x: <span class="operator">-</span>contextWidth<span class="operator">/</span><span class="number">2.0</span>, y: <span class="operator">-</span>contextHeight<span class="operator">/</span><span class="number">2.0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// layer </span></span><br><span class="line">        <span class="keyword">if</span> config.layer <span class="operator">==</span> .bottom &#123;</span><br><span class="line">          	<span class="comment">// 正片叠底 详见：https://www.jianshu.com/p/7c92c57cdf6f</span></span><br><span class="line">            context.setBlendMode(.multiply)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 计算绘制的行和列</span></span><br><span class="line">        <span class="keyword">let</span> rowCount <span class="operator">=</span> <span class="type">Int</span>(sqrtLength <span class="operator">/</span> (mStrW <span class="operator">+</span> horizontalSpace)) <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">let</span> columnCount <span class="operator">=</span> <span class="type">Int</span>(sqrtLength <span class="operator">/</span> (mStrH <span class="operator">+</span> verticalSpace)) <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">        <span class="comment">// 此处计算出需要绘制水印文字的起始点，由于水印区域要大于图片区域所以起点在原有基础上移</span></span><br><span class="line">        <span class="keyword">let</span> orignX <span class="operator">=</span> <span class="operator">-</span>(sqrtLength <span class="operator">-</span> contextWidth) <span class="operator">/</span> <span class="number">2.0</span></span><br><span class="line">        <span class="keyword">let</span> orignY <span class="operator">=</span> <span class="operator">-</span>(sqrtLength <span class="operator">-</span> contextHeight) <span class="operator">/</span> <span class="number">2.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> tempOrignX <span class="operator">=</span> orignX</span><br><span class="line">        <span class="keyword">var</span> tempOrignY <span class="operator">=</span> orignY</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span><span class="operator">..&lt;</span>rowCount<span class="operator">*</span>columnCount &#123;</span><br><span class="line">            <span class="comment">// 渲染文本</span></span><br><span class="line">            <span class="type">NSString</span>(string: config.text).draw(in: <span class="type">CGRect</span>(x: tempOrignX, y: tempOrignY, width: mStrW, height: mStrH), withAttributes: attributes)</span><br><span class="line">            <span class="comment">// 换行</span></span><br><span class="line">            <span class="keyword">if</span> i <span class="operator">%</span> rowCount <span class="operator">==</span> <span class="number">0</span> <span class="operator">&amp;&amp;</span> i <span class="operator">!=</span> <span class="number">0</span> &#123;</span><br><span class="line">                tempOrignX <span class="operator">=</span> orignX</span><br><span class="line">                tempOrignY <span class="operator">+=</span> (mStrH <span class="operator">+</span> verticalSpace)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                tempOrignX <span class="operator">+=</span> (mStrW <span class="operator">+</span> horizontalSpace)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        context.restoreGState()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>特别需要注意的地方有2个点：</p>
<ul>
<li>CGContext的坐标系(原点在左下角)和UIKit的坐标系(原点在左上角))不一样，需要转换坐标系。</li>
<li>导出的时候CGContext的坐标系也不一样(原点在右下角)，需要特殊处理<code>config.textAngle - rotation</code>水印旋转角度减去页面自身的旋转角度</li>
</ul>
</blockquote>
</li>
<li><p>导出水印</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> PDFKit</span><br><span class="line"></span><br><span class="line"><span class="comment">/// PDF页码管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PDFWatermarkTool</span>: <span class="title class_">NSObject</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> configuration: <span class="type">Configuration</span> &#123;</span><br><span class="line">        <span class="keyword">didSet</span> &#123;</span><br><span class="line">            <span class="type">PageConfiguration</span>.shared.configuration <span class="operator">=</span> configuration</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> pdfDocument: <span class="type">PDFDocument</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">pdfPath</span>: <span class="type">String</span>, <span class="params">configuration</span>: <span class="type">Configuration</span> <span class="operator">=</span> <span class="type">Configuration</span>()) &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> document <span class="operator">=</span> <span class="type">PDFDocument</span>(url: <span class="type">URL</span>(fileURLWithPath: pdfPath)) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">&quot;请传入有效的PDF路径&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.configuration <span class="operator">=</span> configuration</span><br><span class="line">        <span class="type">PageConfiguration</span>.shared.configuration <span class="operator">=</span> configuration</span><br><span class="line">        pdfDocument <span class="operator">=</span> document</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">        pdfDocument.delegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">exportFile</span>(<span class="params">complate</span>: <span class="keyword">@escaping</span> (<span class="keyword">_</span> outputPath: <span class="type">String</span>?) -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> newConfiguration <span class="operator">=</span> configuration</span><br><span class="line">        newConfiguration.isExport <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">        configuration <span class="operator">=</span> newConfiguration</span><br><span class="line">        </span><br><span class="line">        <span class="type">DispatchQueue</span>.global(qos: .background).async &#123;[<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> `self` <span class="operator">=</span> <span class="keyword">self</span> <span class="keyword">else</span> &#123;<span class="keyword">return</span>&#125;</span><br><span class="line">            <span class="keyword">var</span> path: <span class="type">String</span>?</span><br><span class="line">            path <span class="operator">=</span> <span class="type">NSTemporaryDirectory</span>() <span class="operator">+</span> <span class="string">&quot;test.pdf&quot;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.pdfDocument.write(toFile: path<span class="operator">!</span>) &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;导出文件成功 - <span class="subst">\(path<span class="operator">!</span>)</span>&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">                complate(path)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">PDFWatermarkTool</span>: <span class="title class_">PDFDocumentDelegate</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">classForPage</span>() -&gt; <span class="type">AnyClass</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">FZPDFWatermarkPage</span>.<span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">PDFWatermarkTool</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">PageConfiguration</span> &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">let</span> shared <span class="operator">=</span> <span class="type">PageConfiguration</span>()</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> configuration: <span class="type">FZPDFWatermarkTool</span>.<span class="type">Configuration</span> <span class="operator">=</span> <span class="type">FZPDFWatermarkTool</span>.<span class="type">Configuration</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">PDFWatermarkTool</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Configuration</span> &#123;</span><br><span class="line">        <span class="comment">/// 水印文字</span></span><br><span class="line">        <span class="keyword">var</span> text: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;维权必究&quot;</span></span><br><span class="line">        <span class="comment">/// 文本颜色</span></span><br><span class="line">        <span class="keyword">var</span> textColor: <span class="type">UIColor</span> <span class="operator">=</span> .red</span><br><span class="line">        <span class="comment">/// 文本字体</span></span><br><span class="line">        <span class="keyword">var</span> textFont: <span class="type">UIFont</span> <span class="operator">=</span> .systemFont(ofSize: <span class="number">16</span>)</span><br><span class="line">        <span class="comment">/// 文字垂直方向间距</span></span><br><span class="line">        <span class="keyword">var</span> textVerticalSpace: <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">50.0</span></span><br><span class="line">        <span class="comment">/// 文字水平方向间距</span></span><br><span class="line">        <span class="keyword">var</span> textHorizontalSpace: <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">50.0</span></span><br><span class="line">        <span class="comment">/// 透明度</span></span><br><span class="line">        <span class="keyword">var</span> textAlpha: <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">1.0</span></span><br><span class="line">        <span class="comment">/// 倾斜角度</span></span><br><span class="line">        <span class="keyword">var</span> textAngle: <span class="type">Int</span> <span class="operator">=</span> <span class="number">45</span></span><br><span class="line">        <span class="comment">/// 图层 顶部和底部</span></span><br><span class="line">        <span class="keyword">var</span> layer: <span class="type">Layer</span> <span class="operator">=</span> .bottom</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/// 开始页面位置</span></span><br><span class="line">        <span class="keyword">var</span> startPageIndex: <span class="type">Int</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">        <span class="comment">/// 结束页面位置</span></span><br><span class="line">        <span class="keyword">var</span> endPageIndex: <span class="type">Int</span> <span class="operator">=</span> .max</span><br><span class="line">        <span class="comment">/// 是否是导出</span></span><br><span class="line">        <span class="keyword">var</span> isExport: <span class="type">Bool</span> <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Vertical</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> top</span><br><span class="line">        <span class="keyword">case</span> bottom</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Horizontal</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> left</span><br><span class="line">        <span class="keyword">case</span> right</span><br><span class="line">        <span class="keyword">case</span> center</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Layer</span>:<span class="title class_">Codable</span>, <span class="title class_">CaseIterable</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> top</span><br><span class="line">        <span class="keyword">case</span> bottom</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TODO: 这里导出的时候会走PDFPage的<code>func draw(with box: PDFDisplayBox, to context: CGContext)</code>方法，并且是一页一页的去渲染，最后再写入到文件里面，理论上可以获取导出进度的。</p>
</li>
</ul>
<h3 id="页面展示"><a href="#页面展示" class="headerlink" title="页面展示"></a>页面展示</h3><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> PDFKit</span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ViewController</span>: <span class="title class_">UIViewController</span> &#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">var</span> pdfView: <span class="type">PDFView</span> <span class="operator">=</span> &#123;</span><br><span class="line">      	<span class="keyword">let</span> view <span class="operator">=</span> <span class="type">PDFView</span>(frame: <span class="keyword">self</span>.view.frame)</span><br><span class="line">        view.autoScales <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">        view.isUserInteractionEnabled <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">				view.backgroundColor <span class="operator">=</span> .main_bg_blue_color</span><br><span class="line"><span class="comment">//        view.displayMode = .twoUp</span></span><br><span class="line">        view.displayBox <span class="operator">=</span> .artBox</span><br><span class="line"><span class="comment">//        view.usePageViewController(true, withViewOptions: nil)</span></span><br><span class="line">        view.displayDirection <span class="operator">=</span> .vertical</span><br><span class="line">        view.autoScales <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">var</span> pdfWatermark: <span class="type">FZPDFWatermarkTool</span> <span class="operator">=</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> pdfUrl <span class="operator">=</span> <span class="type">Bundle</span>.main.url(forResource: <span class="string">&quot;ASample&quot;</span>, withExtension: <span class="string">&quot;pdf&quot;</span>)</span><br><span class="line">        <span class="keyword">let</span> config <span class="operator">=</span> <span class="type">PDFWatermarkTool</span>.<span class="type">Configuration</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> pdfWatermark <span class="operator">=</span> <span class="type">PDFWatermarkTool</span>(pdfPath: (pdfUrl<span class="operator">?</span>.path)<span class="operator">!</span>, configuration: config)</span><br><span class="line">        <span class="keyword">return</span> pdfWatermark</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidLoad</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        pdfView.document <span class="operator">=</span> pdfWatermark.pdfDocument</span><br><span class="line"></span><br><span class="line">        view.addSubview(pdfView)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h3><p>官方添加水印资料: <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/pdfkit/custom_graphics">https://developer.apple.com/documentation/pdfkit/custom_graphics</a></p>
<p>PDFKit苹果官方资料：<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/pdfkit">https://developer.apple.com/documentation/pdfkit</a></p>
<p>Quartz 2D：<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/coregraphics">https://developer.apple.com/documentation/coregraphics</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">roMummy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://romummy.github.io/2022/07/20/iOS PDF添加水印/">http://romummy.github.io/2022/07/20/iOS PDF添加水印/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://romummy.github.io">roMummy</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AD%A6%E4%B9%A0/">学习</a></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="next-post pull-right"><a href="/2019/04/09/APP%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/"><span>APP启动优化</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '24af658de34aaa18ccee',
  clientSecret: '91cd56ec2ab784fc8436eec4ee72d7a7dde9e158',
  repo: 'romummy.github.io',
  owner: 'roMummy',
  admin: 'roMummy',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(/img/top.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2022 By roMummy</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>